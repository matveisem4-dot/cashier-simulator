<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Sberbank Kassa Simulation (Terminal)</title>
    <style>
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #004d2a 0%, #00a851 100%); display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        #terminal { padding: 40px; width: 480px; background: white; border-radius: 20px; text-align: center; box-shadow: 0 0 10px rgba(0,0,0,0.5); position: relative; }
        #terminal-id { position: absolute; top: 10px; right: 10px; font-size: 0.9em; color: #aaa; }
        h1 { color: #00703C; }
        .status { margin-top: 20px; padding: 12px; border-radius: 8px; font-weight: bold; }
        .pending { color: #D39E00; background-color: #FFF8E1; }
        .paid { color: #00703C; background-color: #E8F5E9; }
        input, button { padding: 15px; margin-top: 15px; border-radius: 8px; border: 1px solid #ccc; width: 100%; box-sizing: border-box; }
        button { background-color: #00703C; color: white; border: none; cursor: pointer; font-weight: bold; }
        #qrCodeContainer img { width: 250px; height: 250px; margin-top: 25px; }
        #receipt { display: none; margin-top: 30px; border-top: 2px dashed #ddd; padding-top: 20px; font-family: monospace; }
        #completeButton { display: none; background: #222; }
    </style>
</head>
<body>
    <div id="terminal">
        <div id="terminal-id">ID: <span id="terminalIdDisplay"></span></div>
        <h1>Симулятор POS-терминала</h1>
        <input type="number" id="amountInput" value="1500.50" step="0.01">
        <button onclick="startPayment()">Принять оплату по QR</button>
        <div class="status pending" id="statusMessage">Ожидание операции...</div>
        <div id="qrCodeContainer"></div>
        <button id="completeButton" onclick="completePurchase()">Завершить покупку</button>
        <div id="receipt"><p style="text-align: center;">--- Чек ---</p></div>
    </div>

    <script>
        // Генерируем случайный ID терминала при загрузке
        const terminalId = 'T' + Math.floor(Math.random() * 10000);
        document.getElementById('terminalIdDisplay').innerText = terminalId;
        let currentOrderId = null;

        function completePurchase() { location.reload(); }

        function startPayment() {
            const amount = document.getElementById('amountInput').value;
            if (!amount) return alert('Введите сумму!');
            currentOrderId = 'ORD-' + Date.now();
            
            document.getElementById('statusMessage').innerText = `Ожидание оплаты (ID: ${terminalId})...`;
            document.getElementById('statusMessage').className = 'status pending';
            
            // Генерируем QR со ссылкой на страницу управления
            const controlUrl = `${window.location.origin}/control.html?terminal=${terminalId}&order=${currentOrderId}&amount=${amount}`;
            const qrUrl = `api.qrserver.com{encodeURIComponent(controlUrl)}`;
            
            document.getElementById('qrCodeContainer').innerHTML = `<img src="${qrUrl}" alt="QR Code">`;
        }

        // Слушаем изменения в LocalStorage (сигнал от панели управления)
        window.addEventListener('storage', (event) => {
            if (event.key === 'payment_signal' && currentOrderId) {
                const signal = JSON.parse(event.newValue);
                if (signal.terminalId === terminalId && signal.orderId === currentOrderId) {
                    handleSuccess(signal.amount);
                    localStorage.removeItem('payment_signal'); // Очищаем сигнал
                }
            }
        });

        function handleSuccess(amount) {
            document.getElementById('statusMessage').innerText = `✅ УСПЕШНО ОПЛАЧЕНО!`;
            document.getElementById('statusMessage').className = 'status paid';
            document.getElementById('qrCodeContainer').innerHTML = '';
            document.getElementById('completeButton').style.display = 'block';
            // ... обновление чека ...
        }
    </script>
</body>
</html>
